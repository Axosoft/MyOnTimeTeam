@using MyOnTimeTeam.Models;
@using MyOnTimeTeam.Infrastructure;

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>@ViewBag.Title</title>
    @Styles.Render("~/Content/css")
    @Styles.Render("~/Content/bootstrap")
    @Scripts.Render("~/bundles/modernizr")
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/knockout")
    @Scripts.Render("~/bundles/bootstrap")
    @Scripts.Render("~/bundles/myOnTimeTeam")
    <script type="text/javascript">
        window.siteRoot = '@Utils.GetSiteRoot()';
        if (window.localStorage.getItem('sort') === null) {
            window.localStorage.setItem('sort', 'name');
        }
        if (window.localStorage.getItem('hiddenUsers') === null) {
            window.localStorage.setItem('hiddenUsers', []);
        }
        if (window.localStorage.getItem('showHidden') === null) {
            window.localStorage.setItem('showHidden', false);
        }

        if (window.localStorage.getItem('showInactive') === null) {
            window.localStorage.setItem('showInactive', false);
        }

        if (window.localStorage.getItem('apiCallCounter') == null) {
            var date = new Date();
            window.localStorage.setItem('apiDate', date.getDate() + '/' + date.getMonth() + '/' + date.getYear());
            window.localStorage.setItem('apiCallCounter', 0);
        }

       
    </script>
</head>
<body>


    <div class="navbar navbar-inverse">
        <div class="navbar-inner">
            <a class="brand active" href="~/">My OnTime Team</a>
            @if (HttpContext.Current.Request.Cookies.AllKeys.Contains(Constants.ONTIME_OAUTH_TOKEN) &&
                        !string.IsNullOrEmpty(HttpContext.Current.Request.Cookies[Constants.ONTIME_OAUTH_TOKEN].Value))
            {
                    
                
                <div class="topBar">
                    <span style="margin-top: .25em"></span>
                    <span class="userObject">
                        <img id="userImage" class="icon-" height="16" width="16" />
                        <span id="userName"></span></span>

                    <a class="btn btn-primary btn-small" id="aboutButton">About</a>
                    <a class="btn btn-primary btn-small" id="logoutButton">Logout</a>
                </div>
                <script>
                    window.oauthToken = "@HttpContext.Current.Request.Cookies[Constants.ONTIME_OAUTH_TOKEN].Value";
                    window.ontimeUrl = "@HttpContext.Current.Request.Cookies[Constants.ONTIME_URL].Value";
                    window.myOnTimeTeam.getCurrentUserData().done(function (response) {
                        var data = response.data;
                        $("#userImage").attr("src", data.user_image);
                        $("#userName").text(data.first_name + " " + data.last_name);
                    });



                    var viewModel = window.myOnTimeTeam.refreshData();








                    $('#aboutButton').click(function () {
                        $.modalPopup('@Utils.GetSiteRoot()/home/about');
                    });



                </script>
                    
                <div class="modal hide fade" id="apiModal">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h3>API Alert</h3>
                    </div>
                    <div class="modal-body">
                        <p data-bind="text: apiAlertMessage"></p>
                    </div>
                </div>
            }
            else
            {
                <a class="btn btn-primary btn-small pull-right" id="loginButton">Login</a>
            }
        </div>

        @if (HttpContext.Current.Request.Cookies.AllKeys.Contains(Constants.ONTIME_OAUTH_TOKEN) &&
                        !string.IsNullOrEmpty(HttpContext.Current.Request.Cookies[Constants.ONTIME_OAUTH_TOKEN].Value))
        {
            <div class="container accordion" id="containerBar">
                <div class="accordion-group">
                    <div class="accordion-heading controlBar">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#containerBar" href="#filterCollapse">Options Bar</a>

                    </div>
                    <div class="controlBar accordion-body collapse in" id="filterCollapse">
                        <div class="row-fluid filterBar">
                            <div class="span7">
                                <div class="row-fluid">

                                    <div class="span4">

                                        <label>
                                            <!-- ko text: itemTypes()[0] -->
                                            <!-- /ko -->
                                        </label>
                                        <!-- populates defect filter-->
                                        <select data-bind="options: itemFilters()[0], optionsText: 'name', optionsValue: 'id', value: defectId "></select>

                                    </div>

                                    <div class="span4">
                                        <label>
                                            <!-- ko text: itemTypes()[1] -->
                                            <!-- /ko -->
                                        </label>
                                        <!-- populates features filter-->
                                        <select data-bind="options: itemFilters()[1], optionsText: 'name', optionsValue: 'id', value: featureId "></select>
                                    </div>
                                    <div class="span4">
                                        <label>
                                            <!-- ko text: itemTypes()[2] -->
                                            <!-- /ko -->
                                        </label>
                                        <!-- populates incidents filter -->
                                        <select data-bind="options: itemFilters()[2], optionsText: 'name', optionsValue: 'id', value: incidentId "></select>
                                    </div>
                                </div>
                            </div>
                            <div class="span5">
                                <div class="row-fluid">
                                    <div class="span6">
                                        <label>Projects</label>
                                        <select data-bind="options: projects, optionsText: 'name', optionsValue: 'id', value: projectId "></select>
                                    </div>
                                    <div class="span6">
                                        <label>Releases</label>
                                        <select data-bind="options: releases, optionsText: 'name', optionsValue: 'id', value: releaseId "></select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row-fluid miscBar">
                            <div class="span7 text-center">
                                <div class="span6">
                                    <br />
                                    <label class="checkbox inline">
                                        <input type="checkbox" id="showHidden" data-bind="checked: showHidden" />Show Hidden Users
                                    </label>
                                </div>
                                <div class="span6">
                                    <br />
                                    <label class="checkbox inline">
                                        <input type="checkbox" id="showInactive" data-bind="checked: showInactive" />Show Inactive Users</label>
                                </div>
                            </div>
                            <div class="span5 text-center">
                                <label>Sort By</label>
                                <select data-bind="value: sortBy">
                                    <option value="name">User Name
                                            
                                    </option>
                                    <option value="work">Work Remaining
                                            
                                    </option>
                                    <option value="defects">Defect Count
                                            
                                    </option>
                                    <option value="features">Feature Count
                                            
                                    </option>
                                    <option value="incidents">Incident Count
                                            
                                    </option>
                                    <option value="items">Item Count 
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

    </div>


    @RenderBody()
    @if (!(HttpContext.Current.Request.Cookies.AllKeys.Contains(Constants.ONTIME_OAUTH_TOKEN) &&
                        !string.IsNullOrEmpty(HttpContext.Current.Request.Cookies[Constants.ONTIME_OAUTH_TOKEN].Value)))
    {
        <div class="welcome">
            <p>@ViewBag.message</p>
        </div>
    }

    @RenderSection("scripts", required: false)
    <script>
        if ($('#loginButton')) {
            $('#loginButton').click(function () {
                $.modalPopup('@Utils.GetSiteRoot()/accounts/logon');
            });
        }
        if ($('#logoutButton')) {
            $('#logoutButton').click(function () {
                document.cookie = encodeURIComponent("@Constants.ONTIME_OAUTH_TOKEN") + "=deleted; expires=" + new Date(0).toUTCString() + ";";
                    document.cookie = encodeURIComponent("@Constants.ONTIME_URL") + "=deleted; expires=" + new Date(0).toUTCString() + ";";

                    document.location = "";
                });


            }



    </script>
    </div>
</body>
</html>
